<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>Live Stream & Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
      video {
        background-color: black;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <h2>ë°©ì†¡ ì…ì¥ ë° ì‹œì²­</h2>
    <input type="number" id="streamId" placeholder="ë°©ì†¡ ID (youtubeStreamId)" />
    <input type="text" id="streamKey" placeholder="ìŠ¤íŠ¸ë¦¼í‚¤ (ì˜ˆ: test123)" />
    <input type="text" id="accessToken" placeholder="ì•¡ì„¸ìŠ¤ í† í°" />
    <button onclick="joinAndPlay()">ì…ì¥ ë° ë°©ì†¡ ì‹œì²­</button>
    <div id="roomStatus"></div>
    <div id="viewerCount">ì‹œì²­ì ìˆ˜: 0</div>

    <h2>ì±„íŒ…</h2>
    <input type="text" id="message" placeholder="ë©”ì‹œì§€ ì…ë ¥" />
    <button onclick="sendMessage()">ì „ì†¡</button>
    <ul id="chatList"></ul>

    <h1>ğŸ¥ Live HLS Player</h1>
    <video id="video" width="720" controls autoplay muted playsinline style="display: none"></video>

    <script>
      let socket = null;
      let currentRoomId = null;

      function joinAndPlay() {
        const streamId = document.getElementById('streamId').value;
        const streamKey = document.getElementById('streamKey').value;
        const accessToken = document.getElementById('accessToken').value;
        if (!streamId) return alert('ë°©ì†¡ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        if (!streamKey) return alert('ìŠ¤íŠ¸ë¦¼í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

        // HLS ìŠ¤íŠ¸ë¦¼ URL ìƒì„±
        const variant = '_720p2628kbs';
        const videoSrc = `http://localhost/hls/${streamKey}${variant}/index.m3u8`;

        // ì˜ìƒ ì¬ìƒ
        const video = document.getElementById('video');
        video.style.display = '';
        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(videoSrc);
          hls.attachMedia(video);
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = videoSrc;
        }

        // ì±„íŒ… ì†Œì¼“ ì—°ê²° ë° ì…ì¥
        if (socket) socket.disconnect();
        socket = io('http://localhost:3000/chat', {
          query: {
            accessToken: accessToken,
          },
        }); // ì„œë²„ ì£¼ì†Œì— ë§ê²Œ ìˆ˜ì •
        socket.on('connect', () => {
          socket.emit('joinRoom', { youtubeStreamId: Number(streamId) }, (msg) => {
            document.getElementById('roomStatus').innerText = msg;
            currentRoomId = streamId;
            document.getElementById('chatList').innerHTML = '';
          });
        });

        socket.on('chat', (msg) => {
          const li = document.createElement('li');
          if (typeof msg === 'string') {
            li.innerText = msg;
          } else if (msg && msg.message) {
            li.innerText = `[${msg.userId ?? 'ìµëª…'}] ${msg.message}`;
          }
          document.getElementById('chatList').appendChild(li);
        });

        socket.on('viewerCount', (count) => {
          document.getElementById('viewerCount').innerText = `ì‹œì²­ì ìˆ˜: ${count}`;
        });
      }

      function sendMessage() {
        const message = document.getElementById('message').value;
        if (!currentRoomId) return alert('ë¨¼ì € ë°©ì†¡ì— ì…ì¥í•˜ì„¸ìš”.');
        if (!message) return;
        socket.emit('chat', { youtubeStreamId: Number(currentRoomId), message });
        document.getElementById('message').value = '';
      }
    </script>
  </body>
</html>
